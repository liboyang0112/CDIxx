<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>Atto CDI</title>

  </head>
  <body>
    <p>Working folder: <input type="text" value="" name="path" id="path"><!-- onchange="loadlog(event)"-->
    <button id="setpath">Confirm Folder</button>
    <a href="images">Show repository</a></p>
    <a href="" id="showpath"></a>
    <p>Monochromatization Config:</p>
    <p><textarea id="monoconfig" contenteditable="true" rows="20" cols="80">
      After selecting working folder, you can edit file here</textarea></p>
    <button id="savepulse">Save</button>
    <p>CDI Reconstruction Config:</p>
    <p><textarea id="cdiconfig" contenteditable="true" rows="20" cols="80">
      After selecting working folder, you can edit config file here</textarea></p>
    <button id="savecdi">Save</button>
    <p>Attention: File name starts with letters and only contains letters, numbers, "_" and one "." for extensions.</p>
    <p>Upload background: <input type="file" id="background" >
    Upload pattern: <input type="file" id="image" ></p>
    <button id="uploadimg">Upload</button>
    <p>Upload Spectrum: <input type="file" id="spectrum" ></p>
    <button id="uploadspect">Upload</button>
    <p>Select Background: <input type="text" name="runbkgfile" id="runbkgfile">
    Select Pattern: <input type="text" name="runimgfile" id="runimgfile"></p>
    <button id="prepare">Prepare Monochromatization</button>
    <button id="monochrome_btn">Run Monochromatization</button>
    <button id="cdi_btn">Run CDI</button>
    <button id="rotate_btn">Rotate image</button>
    <button id="flip_btn">Flip image</button>
    <p><img id="logimg" width="200"><img id="solved" width="200"><img id="recon" width="200"></p>
    <p><img id="residual" width="200"><img id="spectrum_plt" width="400"></p>
    <p>Prepare log:</p><code id="preparelog"></code>
    <p>Monochromatization log:</p><code id="monolog"></code>
    <p>CDI log:</p><code id="cdilog"></code>
  </body>
</html>
<script>
  const nodeurl = window.location.origin+':8080'
  const url_cmd = "runcommand.php"
  const repo = 'images/'
  document.getElementById("setpath").addEventListener('click',async ()=>{
    url_path = "setpath.php"
    if(document.getElementById('path').value == "") {
      document.getElementById('showpath').innerText = "Path not filled, please fill the text before click confirm";
      return;
    }else{
      ele = document.getElementById('showpath');
      ele.href=repo+document.getElementById('path').value;
      ele.innerText = "Path: " + repo+document.getElementById('path').value;
    }
    await fetch(url_path, {
      method: 'POST',
      body: repo+document.getElementById('path').value
    }).then(response => {
      return response.text();
    });
    fetch(nodeurl+"/read",{
      method: 'POST',
      body: repo+document.getElementById('path').value+"/pulse.cfg"
    }).then(response=>{return response.text()}).then(data=>{
      document.getElementById('monoconfig').value = data;
    })
    fetch(nodeurl+"/read",{
      method: 'POST',
      body: repo+document.getElementById('path').value+"/cdi.cfg"
    }).then(response=>{return response.text()}).then(data=>{
      document.getElementById('cdiconfig').value = data;
    })
  })
  document.getElementById("uploadimg").addEventListener('click',async ()=>{
    const path = repo + document.getElementById('path').value +"/"
    const url = 'process.php';
    const files = document.getElementById('background').files;
    const sigfiles = document.getElementById('image').files;
    const formData = new FormData();
    formData.append('path', path);
    document.getElementById('runbkgfile').value = files[0].name
    document.getElementById('runimgfile').value = sigfiles[0].name
    formData.append('files[]', files[0]);
    formData.append('files[]', sigfiles[0]);
    fetch(url, {
      method: 'POST',
      body: formData
    }).then(response => {
      return response.text();
    });
  });
  document.getElementById("uploadspect").addEventListener('click',async ()=>{
    const path = repo + document.getElementById('path').value +"/"
    const url = 'process.php';
    const file = document.getElementById('spectrum').files;
    const formData = new FormData();
    formData.append('path', path);
    formData.append('files[]', file[0]);
    fetch(url, {
      method: 'POST',
      body: formData
    }).then(response => {
      return response.text();
    });
  });
  document.getElementById("prepare").addEventListener('click',async ()=>{
    button = document.getElementById("prepare");
    button.disabled = true;
    var timestamp = new Date().getTime();
    const path = repo + document.getElementById('path').value +"/"
    const comd = "./runStacker.sh "+ path + " "
      + document.getElementById('runbkgfile').value
      + " " + document.getElementById('runimgfile').value;
    fetch(url_cmd, {
      method: 'POST',
      body: comd,
    }).then(response => {
      return response.text();
    }).then(data => {
      document.getElementById('preparelog').innerText = data;
      document.getElementById('logimg').src = path+"logimagemerged.png?t=" + timestamp;
      button.removeAttribute("disabled");
    });
    return;
  })
  document.getElementById("monochrome_btn").addEventListener('click',async ()=>{
    button = document.getElementById("monochrome_btn");
    button.disabled = true;
    const path = repo + document.getElementById('path').value +"/"
    var timestamp = new Date().getTime();
    fetch(url_cmd, {
      method: 'POST',
      body: "./runPulseGen.sh "+path
    }).then(response => {
      return response.text();
    }).then(data => {
      document.getElementById('monolog').innerText = data;
      document.getElementById('logimg').src = path+"mergedlog0.png?t=" + timestamp;
      document.getElementById('solved').src = path+"solvedlog0.png?t=" + timestamp;
      document.getElementById('residual').src = path+"residual_pulseGen.png?t=" + timestamp;
      document.getElementById('spectrum_plt').src = path+"spectra.png?t=" + timestamp;
      button.removeAttribute("disabled");
    });
    return;
  });
  let degree = 0;
  let flip = 1;
  document.getElementById("rotate_btn").addEventListener('click',async ()=>{
    degree += 90;
    if(degree == 360) degree = 0;
    document.getElementById('recon').style.transform = "rotate(-" + degree.toString() + "deg) scaleX(" + flip + ")";
  });
  document.getElementById("flip_btn").addEventListener('click',async ()=>{
    flip *=-1;
    document.getElementById('recon').style.transform = "rotate(-" + degree.toString() + "deg) scaleX(" + flip + ")";
  });
  document.getElementById("cdi_btn").addEventListener('click',async ()=>{
    button = document.getElementById("cdi_btn");
    button.disabled = true;
    const path = repo + document.getElementById('path').value +"/"
    var timestamp = new Date().getTime();
    fetch(url_cmd, {
      method: 'POST',
      body: "./runCDI.sh "+path
    }).then(response => {
      return response.text();
    }).then(data => {
      document.getElementById('cdilog').innerText = data;
      document.getElementById('recon').src = path+"recon_intensity_cropped.png?t=" + timestamp;
      button.removeAttribute("disabled");
    });
    return;
  });
  document.getElementById("savepulse").addEventListener('click',async ()=>{
    fetch(nodeurl+"/save/"+repo+document.getElementById('path').value+"/pulse.cfg",{
      method: 'POST',
      body: document.getElementById('monoconfig').value
    });
  })
  document.getElementById("savecdi").addEventListener('click',async ()=>{
    fetch(nodeurl+"/save/"+repo+document.getElementById('path').value+"/cdi.cfg",{
      method: 'POST',
      body: document.getElementById('cdiconfig').value
    });
  })
</script>
